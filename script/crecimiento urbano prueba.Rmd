---
title: "crecimiento urbano prueba"
author: "Claudia Tribaldos"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

HISDAC-ES: Historical Settlement Data Compilation for Spain (1900 - 2020) (https://doi.org/10.5194/essd-2023-53)

```{r}
#install.packages("CatastRo")
library("CatastRo")
```


We can create also thematic maps using the information available on the spatial objects. We would produce a visualization of the urban growth of Valencia using CatastRo, replicating the map produced by Dominic Royé on his post Visualize urban growth, using the ATOM services.


# ejemplo almería  

```{r}
library(dplyr)
library(sf)
library(mapSpain)

# Use mapSpain for getting the coords

alm <- esp_get_capimun(munic = "^Almería$")
```

Next step consists on extracting the buildings using the ATOM service. We would use also the function catr_get_code_from_coords() to identify the code of Valencia in the Cadastre, and we would download the buildings with catr_atom_get_buildings().

```{r}
alm_catr_code <- catr_get_code_from_coords(alm)

alm_catr_code

almeria_bu <- catr_atom_get_buildings(alm_catr_code$catrcode)
```


Next step for creating the visualization is to limit the analysis to a circle of radius 2.5 km around the city center:


```{r}
buff <- alm %>%
  # Adjust CRS to 25830: (Buildings)
  st_transform(st_crs(almeria_bu)) %>%
  # Buffer
  st_buffer(5000)

# Cut buildings

dataviz <- st_intersection(almeria_bu, buff)

library(ggplot2)
ggplot(dataviz) +
  geom_sf()
```


Let’s extract now the construction year, available in the column beginning:

```{r}
# Extract 4 initial positions
year <- substr(dataviz$beginning, 1, 4)

# Replace all that doesn't look as a number with 0000
year[!(year %in% 0:5000)] <- "0000"

# To numeric
year <- as.integer(year)

# New column
dataviz <- dataviz %>%
  mutate(year = year)
```

Last step is to create groups based on the year and create the data visualization. We use here the function ggplot2::cut_number() to create 15 different classes:

```{r}
dataviz <- dataviz %>%
  mutate(year_cat = ggplot2::cut_number(year,
    n = 15
  ))


ggplot(dataviz) +
  geom_sf(aes(fill = year_cat), color = NA) +
  scale_fill_manual(values = hcl.colors(15, "Spectral")) +
  theme_void() +
  labs(title = "ALMERÍA", fill = "") +
  theme(
    panel.background = element_rect(fill = "black"),
    plot.background = element_rect(fill = "black"),
    legend.justification = .5,
    legend.text = element_text(
      colour = "white",
      size = 12
    ),
    plot.title = element_text(
      colour = "white", hjust = .5,
      margin = margin(t = 30),
      size = 30
    ),
    plot.caption = element_text(
      colour = "white",
      margin = margin(b = 20), hjust = .5
    ),
    plot.margin = margin(r = 40, l = 40)
  )
```







